---
lab:
    title: '实验室：使用发布入口控制部署'
    module: '模块 10：设计发布策略'
---

# 实验室：使用发布入口控制部署
# 学生实验室手册

## 实验室概述

本实验室涵盖部署入口的配置，并详细介绍如何使用这些配置来控制 Azure Pipelines 的执行。为说明其实现，你将为 Azure Web 应用配置两个环境下的发布定义。只有当应用没有阻碍性 bug 时，才会部署到 Canary 环境，只有当 Azure Monitor 的 Application Insights 中没有活动警报时，才会标记 Canary 环境完成。

发布管道指定了在一系列环境中部署应用程序时的端到端发布过程。通过使用作业和任务，可以完全自动化到各种环境的部署。理想情况下，你不希望同时向所有用户公开应用程序的新更新。最佳做法是分阶段公开更新，即向部分用户公开，监视其使用情况，并根据最初的一组用户的体验向其他用户公开。

通过审批和入口，你能够在发布中控制部署的开始和完成。通过审批，你可以等待用户手动批准或拒绝部署。使用发布入口，你可以指定版本提升到下一个环境前应用程序必须满足的运行状况标准。在任何环境部署之前或之后，将自动评估所有这些已指定的入口，直到通过全部入口或到了你所定义的超时时间并失败。

入口可以从部署前条件或部署后条件面板添加到发布定义的环境中。可以在环境条件中添加多个入口，以确保发布的所有输入都符合标准。

示例：

- 部署前入口确保在将生成部署到环境之前，工作项或问题管理系统中没有活动问题。
- 部署后入口确保在将已部署的应用发布到下一个环境之前，没有来自该应用的监视或事件管理系统的事件。

默认情况下，每个帐户包含 4 种类型的入口。

- 调用 Azure 函数：触发执行 Azure 函数并确保成功完成。 
- 查询 Azure Monitor 警报：观察为活动警报配置的 Azure Monitor 警报规则。 
- 调用 REST API：调用 REST API 并在返回成功响应后继续。 
- 查询工作项：确保查询返回的匹配工作项数量在阈值内。 

## 目标

完成本实验室后，你将能够：

-   配置发布管道
-   配置发布入口
-   测试发布入口

## 实验室持续时间

-   预计用时：**75 分钟**

## 说明

### 准备工作

#### 登录实验室虚拟机

请确保已使用以下凭据登录到 Windows 10 虚拟机：
    
-   用户名：**Student**
-   密码：**Pa55w.rd**

#### 查看本实验室所需的应用程序

确定你将在本实验室中使用的应用程序：
    
-   Microsoft Edge

#### 设置 Azure DevOps 组织。 

如果还没有可用于本实验室的 Azure DevOps 组织，请按照[创建组织或项目集合](https://docs.microsoft.com/zh-cn/azure/devops/organizations/accounts/create-organization?view=azure-devops)中的说明创建一个。

#### 准备 Azure 订阅

-   标识现有的 Azure 订阅或创建一个新的 Azure 订阅。
-   验证你拥有 Microsoft 帐户或 Azure AD 帐户，该帐户在 Azure 订阅中具有所有者角色并且在与 Azure 订阅关联的 Azure AD 租户中具有全局管理员角色。有关详细信息，请参阅[使用 Azure 门户列出 Azure 角色分配](https://docs.microsoft.com/zh-cn/azure/role-based-access-control/role-assignments-list-portal)和[在 Azure Active Directory 中查看和分配管理员角色](https://docs.microsoft.com/zh-cn/azure/active-directory/roles/manage-roles-portal#view-my-roles)。

### 练习 0：配置实验室先决条件

在本练习中，你将设置实验室先决条件，其中包括基于 Azure DevOps 演示生成器模板预配置的 Parts Unlimited 团队项目和两个分别代表 **Canary** 和“**生产**”环境的 Azure Web 应用，你将通过 Azure Pipelines 将应用程序部署到其中。

#### 任务 1：配置团队项目

在此任务中，你将使用 Azure DevOps 演示生成器基于 **ReleaseGates** 模板生成一个新项目。

1.  在实验室计算机上，启动 Web 浏览器并导航到 [Azure DevOps 演示生成器](https://azuredevopsdemogenerator.azurewebsites.net)。此实用工具将对以下过程进行自动化：在你的帐户中创建预填充了实验室所需内容（工作项、存储库等）的 Azure DevOps 项目。 

    > **备注**：有关该站点的详细信息，请参阅 https://docs.microsoft.com/zh-cn/azure/devops/demo-gen。

1.  单击“**登录**”，并使用与你的 Azure DevOps 订阅相关联的 Microsoft 帐户登录。
1.  如果需要，在“**Azure DevOps 演示生成器**”页面上，单击“**接受**”以接受访问 Azure DevOps 订阅的权限请求。
1.  在“**新建项目**”页面上的页面上的“**新建项目名称**”文本框中，键入“**使用发布入口控制部署**”，在“**选择组织**”下拉列表中选择你的 Azure DevOps 组织，然后单击“**选择模板**”。
1.  在模板列表中，在工具栏中，单击“**DevOps 实验室**”，选择 **ReleaseGates** 模板，然后单击“**选择模板**”。
1.  返回“**新建项目**”页面，单击“**创建项目**”

    > **备注**：等待此过程完成。该过程需要约 2 分钟。如果该过程失败，请导航到你的 DevOps 组织，删除项目并重试。

1.  在“**新建项目**”页面上，单击“**导航到项目**”。

#### 任务 2：创建两个 Azure Web 应用

在此任务中，你将创建两个分别代表 **Canary** 和“**生产**”环境的 Azure Web 应用，你将通过 Azure Pipelines 将应用程序部署到其中。

1.  从实验室计算机启动 Web 浏览器，导航到 [**Azure 门户**](https://portal.azure.com)，并使用用户帐户登录，该帐户在本实验室中将使用的 Azure 订阅中具有所有者角色，并在与此订阅关联的 Azure AD 租户中具有全局管理员角色。
1.  在 Azure 门户中，单击页面顶部搜索文本框右侧的 **Cloud Shell** 图标。 
1.  如果提示选择“**Bash**”或“**PowerShell**”，请选择“**Bash**”。 

    >**备注**：如果这是你第一次打开“**Cloud Shell**”，会看到“**未装载任何存储**”消息，请选择你在本实验室中使用的订阅，然后选择“**创建存储**”。 

1.  在 **Cloud Shell** 窗格中的 **Bash** 提示符下，运行以下命令以创建资源组（将 `<region>` 占位符替换为将托管两个 Azure Web 应用的 Azure 区域的名称，例如“westeurope”或“eastus”）：

    > **备注**：可以通过运行以下命令找到可能的位置，使用 `<region>` 上的“**Name**”： `az account list-locations -o table`

   
    ```bash
    RESOURCEGROUPNAME='az400m10l01-RG'
    az group create -n $RESOURCEGROUPNAME -l '<region>'
    ```

1.  创建应用服务计划
   
    ```bash
    SERVICEPLANNAME='az400m01l01-sp1'
    az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
    ```
1.  使用唯一的应用名称创建两个 Web 应用。
 
     ```bash
     SUFFIX=$RANDOM$RANDOM
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Canary
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Prod
     ```

1.  导航到你在此任务前面部分创建的资源组 **az400m10l01-RG**，然后查看你创建的资源。
1.  在资源列表中，单击 **Canary** Web 应用。 
1.  在 **Canary** Web 应用页面左侧垂直菜单中的“**设置**”部分，单击 **Application Insights**。
1.  在 **Application Insights** 边栏选项卡上，单击“**启用 Application Insights**”，接受默认设置，然后单击“**应用**”以创建 Application Insights 资源并将其连接到 Canary Web 应用。出现确认提示时，单击“**是**”。
1.  等待 Application Insights 资源创建完毕，然后单击显示的消息“你的应用已连接到 Application Insights 资源:“**NAME**””中的“**name**”。

    > **备注**：你将在此处创建监视器警报，并将在本实验室的后续部分使用。 

1.  在“Application Insights 资源”窗口上，单击“**警报**”选项（位于“监视”下方），然后单击“**新建警报规则**”。
1.  在“**创建警报规则**”边栏选项卡上的“**条件**”部分，单击“**添加条件**”链接。 
1.  在“**配置信号逻辑**”边栏选项卡上的“**按信号名称搜索**”文本框中，键入“**失败的请求**”并选择它。 
1.  在“**配置信号逻辑**”边栏选项卡上的“**警报逻辑**”部分中，将“**阈值**”保留设置为“**静态**”，在“**阈值**”文本框中，键入 **0**，然后单击“**完成**”。

    > **备注**：每当最近 5 分钟内失败的请求数大于 0 时，该规则将生成警报。 

1.  返回“**创建警报规则**”窗格，在“**警报规则详细信息**”中指定以下设置，然后单击“**创建警报规则**”（其他设置保留默认值）：

    | 设置 | 值 |
    | --- | --- |
    | 警报规则名称 | **PartsUnlimited_FailedRequests** |
    | 严重性 | **Sev 3** |

    > **备注**：指标警报规则最多可能需要 10 分钟才能激活。

    > **备注**：你可以根据不同的指标创建多个警报规则，例如可用性小于 99%、服务器响应时间大于 5 秒或服务器异常大于 0 个 

### 练习 1：配置发布管道

在本练习中，你将配置发布管道。

#### 任务 1：更新发布任务

在此任务中，你将更新发布任务。

1.  在实验室计算机上，在 Azure DevOps 门户中切换到显示“**使用发布入口控制部署**”项目的浏览器窗口，在垂直导航窗格中，选择 **Pipelines**，然后在 **Pipelines** 部分，单击“**发布**”。 
1.  在“**发布**”视图的 **PartsUnlimited-CD** 窗格中，单击“**编辑**”。

    > **备注**：此管道包含两个阶段，分别叫做“**Canary 环境**”和“**生产**”。 

1.  在“**管道**”选项卡上的“**项目**”矩形中，单击 **PartsUnlimited-CI** 生成项目右上角的“**持续部署触发器**”按钮。
2.  如果 **PartsUnlimited-CI** 生成的持续部署触发器处于禁用状态，请切换开关以启用它。将所有其他设置保留为默认值，并单击右上角的 **x** 标记关闭“**持续部署触发器**”窗格。 
3.  在“**Canary 环境**”阶段，单击“**1 作业，2 任务**”标签。

    > **备注**：Canary 环境有 2 个任务，一个是将包发布到 Azure Web 应用，另一个是在部署后启用对应用程序的持续监视。 

4.  在“**所有管道**”>“**PartsUnlimited-CD**”窗格上，确保已选择“**Canary 环境**”阶段。在“**Azure 订阅**”下拉列表中，选择你的 Azure 订阅，然后单击“**授权**”。如果出现提示，请使用在 Azure 订阅中具有所有者角色的用户帐户进行身份验证。
5.  在“**应用服务名称**”下拉列表中，选择 **Canary** Web 应用的名称。
6.  在“**资源组和 Application Insights**”下拉列表中，选择 **az400m10l01-RG** 条目。
7.  在“**Application Insights 资源名称**”下拉列表中，选择 **Canary** Application Insights 资源的名称，该名称应与 **Canary** Web 应用的名称匹配。 
8.  在“**所有管道”>“PartsUnlimited-CD**”窗格上，单击“**任务**”选项卡，然后在下拉列表中选择“**生产**”。
9.  选中“**生产**”阶段后，在“**Azure 订阅**”下拉列表中，选择“**可用 Azure 服务连接**”下显示的用于“**Canary 环境**”阶段的 Azure 订阅，因为我们在授权订阅使用之前就已经创建了服务连接。
10. 在“**应用服务名称**”下拉列表中，选择 **Prod** Web 应用的名称。
11. 在“**所有管道”>“PartsUnlimited-CD**”窗格上，单击“**保存**”，然后在“**保存**”对话框中，单击“**确定**”。
12. 在“**管道**”窗格上，单击代表 **PartsUnlimited-CI** 生成管道的条目，然后在 **PartsUnlimited-CI** 窗格上单击“**运行管道**”。 
13. 在“**运行管道**”窗格上，接受默认设置，然后单击“**运行**”以触发管道。**等待生成管道完成**。

    > **备注**：生成成功后，将自动触发发布，并将应用程序部署到两个环境中。

14. 在垂直导航窗格的 **Pipelines** 部分，单击“**发布**”，然后在 **PartsUnlimited-CD** 窗格中，单击代表最新发布的条目。

15. 在“**PartsUnlimited-CD”>“Release-1**”边栏选项卡上，跟踪发布进度并验证两个 Web 应用的部署是否成功完成。
16. 切换到 Azure 门户界面，导航到资源组 **az400m10l01-RG**，在资源列表中，单击 **Canary** Web 应用，在 Web 应用边栏选项卡上，单击“**浏览**”，并验证网页是否在新的 Web 浏览器标签页中成功加载。
17. 关闭显示 **Parts Unlimited** 网站的 Web 浏览器标签页。
18. 切换到 Azure 门户界面，导航到资源组 **az400m10l01-RG**，在资源列表中，单击“**生产**”Web 应用，在 Web 应用边栏选项卡上，单击“**浏览**”，并验证网页是否在新的 Web 浏览器标签页中成功加载。
19. 关闭显示 **Parts Unlimited** 网站的 Web 浏览器标签页。

    > **备注**：现在，应用程序已经配置了 CI/CD。在下一个练习中，我们将在发布管道中设置入口。

### 练习 2：配置发布入口。

在本练习中，你将在发布管道中设置入口。

#### 任务 1：配置部署前入口

在此任务中，你将配置部署前入口。

1.  切换到显示 Azure DevOps 门户的 Web 浏览器窗口，在垂直导航窗格中的 **Pipelines** 部分，单击“**发布**”，然后在 **PartsUnlimited-CD** 窗格中单击“**编辑**”。
1.  在“**所有管道”>“PartsUnlimited-CD**”窗格上，在代表“**Canary 环境**”阶段的矩形的左边缘上，单击代表“**部署前条件**”的椭圆形。
1.  在“**部署前条件**”窗格上，将“**部署前审批**”滑块设置为“**启用**”，然后在“**审批者**”文本框中，键入并选择你的 Azure DevOps 帐户名称。 
1.  在“**部署前条件**”窗格上，将“**入口**”滑块设置为“**启用**”，单击“**添加**”，然后在弹出菜单中单击“**查询工作项**”。
1.  在“**部署前条件**”窗格上“**查询工作项**”部分的“**查询**”下拉列表中，选择“**共享查询**”下的 Bug，将“**上限阈值**”的值设置为 **0**。

    > **备注**：基于“**上限阈值**”设置的值，如果此查询返回任何活动的 bug 工作项，则发布入口将失败。

1.  在“**部署前条件**”窗格上，将“**评估前的延迟时间**”设置的值保留为“**5 分钟**”。 

    > **备注**：“**评估前的延迟时间**”表示第一次评估添加的入口之前的时间。如果未添加任何入口，则部署将等待一段时间，然后再继续。要使入口函数可以初始化且稳定（它可能需要一些时间才能开始返回准确的结果），我们在评估结果之前配置一个延迟，然后将其用于确定应批准还是拒绝部署。

1.  在“**部署前条件**”窗格上，展开“**评估选项**”部分并配置以下选项：

    - 将“**重新评估入口的间隔时间**”值设置为“**5 分钟**”。

    > **备注**：“**重新评估入口的间隔时间**”表示所有入口的每次评估时间间隔。在每个采样间隔，新请求将同时发送到每个入口以获取新结果。采样间隔必须大于任何已配置入口的最长典型响应时间，以便有时间接收所有响应。

    - 将“**入口失败后超时时间**”值设置为“**8 分钟**”。

    > **备注**：“**入口失败后超时时间**”表示所有入口的最大评估周期。如果在同一采样间隔内所有入口都成功之前已达到超时时间，则部署将被拒绝。我们可以为超时指定的最小值为 6 分钟，可为采样间隔指定的最小值为 5 分钟。

    > **备注**：在这种情况下，触发发布时，入口将在 *0* 到 *5* 分钟之内验证样本。如果结果为“**通过**”，则将发送通知以供审批。如果结果为“**失败**”，则发布将在 *8* 分钟后超时。

    > **备注**：实际上，这些值可能跨越几个小时。 

1.  在“**部署前条件**”窗格上，选择“**在成功的入口上，请求批准**”单选按钮。
1.  单击右上角的 **x** 标记，关闭“**部署前条件**”窗格。**保存**发布管道中的更改。

1.  为了使“**查询工作项**”入口正常工作，**项目生成服务**需要对 Azure Boards 查询具有“读取”权限。
1.  在 Azure DevOps 门户的垂直导航窗格中，将鼠标指针悬停在 **Boards** 上，在按住 **Ctrl** 键的同时单击“**查询**”，以使用“**查询**”窗格打开单独的浏览器标签页。
1.  在 **Boards** 视图的“**查询**”窗格上，单击“**全部**”以获取包含所有查询的列表。
1.  右键单击“**共享查询**”文件夹，然后选择“**安全性…**”打开“**共享查询权限**”窗格。
1.  在“**共享查询权限**”窗格上的“**搜索用户或组**”字段中，键入或粘贴“**使用发布入口生成服务控制部署**”（[项目名称] 生成服务），然后单击找到的一个标识。

    > **备注**：必须按照如上所述搜索“**使用发布入口生成服务控制部署**”用户，但该用户尚未显示为“**用户**”列表的成员。不要将“**项目集合生成服务**”用户与“**项目生成服务**”混淆。

1.  在“**用户**”列表中选择“**使用发布入口生成服务控制部署**”用户，然后在右侧将“**读取**”权限设置为“**允许**”。
1.  单击右上角的 **x** 标记，关闭“**共享查询权限**”窗格。
1.  导航回到浏览器标签页，其中发布管道仍处于打开状态。
   
#### 任务 2：配置部署后入口

在此任务中，你将启用 Canary 环境的部署后入口。

1.  返回“**所有管道”>“PartsUnlimited-CD**”窗格，在代表“**Canary 环境**”阶段的矩形的左边缘上，单击代表“**部署后条件**”的椭圆形。
1.  在“**部署后条件**”窗格上，将“**入口**”滑块设置为“**启用**”，单击“**添加**”，然后在弹出菜单中单击“**查询 Azure Monitor 警报**”。
1.  在“**部署后条件**”窗格“**查询 Azure Monitor 警报**”部分的“**Azure 订阅**”下拉列表中，选择代表你的 Azure 订阅（位于“可用 Azure 服务”下方）的条目，然后在“**资源组**”下拉列表中选择 **az400m10l01-RG** 条目。
1.  在“**部署后条件**”窗格上，展开“**评估选项**”并配置以下选项：

- 将“**重新评估入口的间隔时间**”值设置为“**5 分钟**”。
- 将“**入口失败后超时时间**”值设置为“**8 分钟**”。
- 选择“**在成功的入口上，请求批准**”选项。

    > **备注**：采样间隔和超时一起作用，确保入口以适当的间隔调用函数，如果在超时周期同一采样间隔内未成功执行函数，则将拒绝部署。 

1.  单击右上角的 **x** 标记，关闭“**部署后条件**”窗格。
1.  返回 **PartsUnlimited-CD** 窗格，单击“**保存**”，然后在“**保存**”对话框中，再次单击“**保存**”。 


### 练习 3：测试发布入口

在本练习中，你将通过更新应用程序来测试发布入口，这将触发部署。

#### 任务 1：添加发布入口后更新和部署应用程序

在此任务中，你将对应用程序代码进行较小的更改，将更新提交到存储库，并跟踪生成和发布过程。

1.  在显示 Azure DevOps 门户的浏览器窗口的垂直导航窗格中，选择“**发布**”。 
1.  单击“**创建发布**”和“**创建**”（保留默认值）。
1.  在代表最新运行的窗格上，单击“**发布**”选项卡，然后单击 **PartsUnlimited-CD/Release-2** 条目，并查看“**Canary 环境**”的部署进度。 
1.  在代表“**Canary 环境**”阶段的矩形的左边缘上，单击代表“**预部署条件**”的椭圆，这时可能会被标记为“**评估入口**”或“**部署前入口失败**”。
1.  在“**Canary 环境**”窗格上，请注意“**查询工作项**”入口已失败。

    > **备注**：这表明存在活动的工作项。需要关闭这些工作项后才能继续。下一次采样时间将在 5 分钟后。

1.  打开一个新的浏览器标签页，导航到 Azure DevOps 门户，在垂直导航窗格中，选择 **Boards**，然后在 **Boards** 部分选择“**查询**”。
1.  在 **Boards** 视图的“**查询**”窗格上，单击“**所有**”选项卡。
1.  在“**查询**”窗格“**所有**”选项卡上的“**共享查询**”部分，单击 **Bug** 条目，然后在 **“查询”>“共享查询”>“Bug”** 窗格中，单击“**运行查询**”。 
1.  验证查询是否返回名为“**Canary 环境中的磁盘空间不足**”的工作项，并且该工作项的状态为“**新建**”。

    > **备注**：我们假设基础结构团队已解决磁盘空间问题。 

1.  单击“**Canary 环境中的磁盘空间不足**”条目。
1.  在“**Canary 环境中的磁盘空间不足**”窗格左上角的“**状态**”标签旁边，单击“**新建**”，然后在下拉列表中，单击“**关闭**”，再单击“**保存**”。
1.  切换回“**Canary 环境**”窗格，并等待通过第二次评估。 

    > **备注**：如果第二次评估已失败，则将鼠标指针悬停在代表“**Canary 环境**”阶段的矩形上以显示“**重新部署**”选项，单击“**重新部署**”，然后在“**Canary 环境**”边栏选项卡上单击“**部署**”并监视部署前入口的处理状态。 

    > **备注**：评估成功后，你将看到部署前审批请求。 

1.  单击“**批准**”以在 Canary 环境中进行部署

    > **备注**：成功部署到 Canary 环境后，我们将看到部署后入口正在运行，该入口使用 Application Insights 来检测是否存在针对新部署应用程序的失败请求。 

1.  要触发失败的请求，请切换到显示 Azure 门户的 Web 浏览器窗口，导航到 **Canary** Azure Web 应用边栏选项卡，然后单击“**浏览**”。这将打开一个新的浏览器标签页，其中显示 PartsUnlimited 网站。 
1.  在 PartsUnlimited 网站上，单击“**更多**”。

    > **备注**：网站的此部分故意配置错误，以便触发失败的请求。 

1.  返回到 PartsUnlimited 网站的主页，再次单击“**更多**”，然后重复此步骤几次。
1.  验证 Application Insights 是否检测到失败的请求，操作方法：导航到 **Canary** Web 应用页面的 Application Insights 边栏选项卡，然后在 Application Insights 边栏选项卡上单击“**警报**”，并验证该页面是否列出了一个或多个 **Sev 3** 警报。 

    > **备注**：由于异常触发了警报，因此“**查询 Azure Monitor**”入口将失败。反过来，这将阻止部署到“**生产**”环境。

### 练习 4：删除 Azure 实验室资源

在本练习中，你将删除在本实验室中预配的 Azure 资源，避免产生意外费用。 

>**备注**：请记得删除任何新创建而不会再使用的 Azure 资源。删除未使用的资源，确保不产生意外费用。

#### 任务 1：删除 Azure 实验室资源

在此任务中，你将使用 Azure Cloud Shell 删除在本实验室中预配的 Azure 资源，避免产生不必要的费用。 

1.  在 Azure 门户中，在 **Cloud Shell** 窗格中打开 **Bash** Shell 会话。
1.  运行以下命令，列出在本模块各实验室中创建的所有资源组：

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].name" --output tsv
    ```

1.  运行以下命令，删除在本模块各个实验室中创建的所有资源组：

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    >**备注**：该命令以异步方式执行（由 --nowait 参数决定），因此，虽然你随后可在同一 Bash 会话中立即运行另一个 Azure CLI 命令，但实际上要花几分钟才能删除资源组。

## 回顾

在本实验室中，你配置了发布管道，然后配置并测试了发布入口。 
